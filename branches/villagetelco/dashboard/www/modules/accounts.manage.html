<!--
 * Afrimesh: easy management for B.A.T.M.A.N. wireless mesh networks
 * Copyright (C) 2008-2009 Meraka Institute of the CSIR
 * All rights reserved.
 *  
 * This software is licensed as free software under the terms of the
 * New BSD License. See /LICENSE for more information.
-->

<div id="accounts-manage">

  <!-- search control -->
  <div style="border: 0px solid red;">
  <input type="text" 
         style="width:400px; height:30px; padding-left:10px; vertical-align:middle;"
         name="seach" id="search" 
         value="" title="Search on account info ..." />
  &nbsp;
  <span id="account-create" class="round button" style="vertical-align:middle;">New Account</span>
  </div>
  <hr />

  <!-- account list -->
  <div class="scrollview" style="top:5.0em;">

    <!-- account editor template -->
    <div id="editor-template" class="round-small editor">
      <input type="hidden" id="id" />
      <input type="text"   id="firstname" title="first name" style="width: 10em;"/>
      <input type="text"   id="lastname"  title="last name"  style="width: 10em;"/>
      <input type="text"   id="email"     title="email"      style="width: 15em;"/>
      <br/>
      <textarea id="address" title="street address" cols="30" rows="4" />
      <div style="text-align:right;">
        <button id="save">save</button>
        <button id="cancel">cancel</button>
      </div>
    </div>

    <!-- account summary template -->
    <div id="accountlist" class="accounts">
      <div id="account-template" style="display:none;"> 
        <span class="expand">+</span>
        <span id="person">unknown</span> 
        <span id="device">0.0.0.0</span>
        <span id="handset">0</span>
      </div>
    </div>
  </div>

</div> <!-- #accounts-manage -->



<script type="text/javascript"> //<![CDATA[    
(function() {

  /** includes ---------------------------------------------------------- */
  /* often a good idea:  load("modules/accounts.manage.js"); *;/


  /** construction ------------------------------------------------------ */
  ready = function() { // INJ 'ready' should be the only symbol we're exposing to the global namespace
    /* often a good place to do this: populate_control(); */
    console.debug("loaded accounts.manage.html");

    /* set up search box */
    //$('input[title!=""]').hint();    
    $("div#accounts-manage input#search").bind("keyup", function(event) {
        if (this.value == "") { 
          return $("div.account").show();
        }
        var filter = this.value;
        $("div.account:not(:contains(" + filter + "))").hide();
        $("div.account:contains(" + filter + ")").show();
	      if (event.keyCode != 13) return true;
        return false;
      });


    /* load data */   
    function populate_control() {
      afrimesh.community.neighbors(function(error, person) {
          if (error) return console.error("Missing community: " + error);
          insert_entry(person);
        });
      
    };
    populate_control();

    $("#account-create").click(function() {
        var clone = $("#account-template").clone()
                                          .addClass("account")
                                          .attr("id", 0)
                                          .prependTo("#accountlist").show();
        var person = {}; //{ id:0, firstname:"", lastname:"", email:"", address:"" };
        var editor = on_show_editor(clone, person);
        editor.find("button#cancel").click(function() { 
            editor.remove(); 
            clone.remove(); 
          });
      });    

    function on_save_person(account) {
      var person = {
        id        : account.find("input#id").val(),
        firstname : account.find("input#firstname").hintval(),
        lastname  : account.find("input#lastname").hintval(),
        email     : account.find("input#email").hintval(),
        address   : account.find("textarea#address").hintval()
      };
      console.log("Saving: " + show(person));

      afrimesh.person.save(person, function(error, person) {  // save person info and get id
          if (error) return console.error("Could not save: " + error); // Show error in editor
          console.log("Save success");
          $("#accountlist").find(".account").remove(); // TODO - a bit drastic :)
          populate_control();
          //console.log("Linking device " + device.ip + " to person: " + person.id);
          //afrimesh.person.link(person, device, continuation);
        }, account.source);

    };

    function insert_entry(person) {
      var clone = $("#account-template").clone()
                                        .addClass("account")
                                        .attr("id", person.id)
                                        .appendTo("#accountlist").show();
      clone.find("#person").html(person.firstname + " " + person.lastname);
      //clone.find("#handset").html(i);
      //clone.find("#device").html("10.0.0." + i);
      clone.find(".expand").toggle(function() { on_show_editor(clone, person); }, 
                                   function() { on_hide_editor(clone); });
    };
    function on_show_editor(account, person) {
      var clone = $("#editor-template").clone()
                                       .attr("id",    "editor");
      clone.appendTo($(account).find("#person")).show();
      $(account).find("#person").addClass("round-small expanded");
      $(account).find(".expand").html("-");
      $("input[title!='']").hint(); $("textarea[title!='']").hint();    
      // set field values
      clone.source = person;
      clone.find("input#id").val(person.id);
      clone.find("input#firstname").hintval(person.firstname);
      clone.find("input#lastname").hintval(person.lastname);
      clone.find("input#email").hintval(person.email);
      clone.find("textarea#address").hintval(person.address);
      clone.find("button#save")  .click(function() { on_save_person(clone);  });
      clone.find("button#cancel").click(function() { account.find(".expand").click(); });
      return clone;
    };
    function on_hide_editor(account) {
      $(account).find(".expand").html("+");
      $(account).find("#person").removeClass("round-small expanded");
      $(account).find("#person #editor").remove();
      return account;
    };
    /* -- */


    return unload;
  };

  function unload() {
    console.debug("unloaded accounts.manage.html");
  };


  /** populate control -------------------------------------------------- */
  function populate_accounts(accounts) {
  };


  /** done -------------------------------------------------------------- */
  console.debug("loaded accounts.manage.js");
 
})();
//]]></script>


