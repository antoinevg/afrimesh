<!--
 * Afrimesh: easy management for B.A.T.M.A.N. wireless mesh networks
 * Copyright (C) 2008-2009 Meraka Institute of the CSIR
 * All rights reserved.
 *  
 * This software is licensed as free software under the terms of the
 * New BSD License. See /LICENSE for more information.
-->

<!-- /* TODO - use the same caching mechanism as the map */
     /* TODO - write the caching mechanism for the map - at what level? villagebus? higher? */ -->


<div id="network-devices">
  <table><tr>
      <td><form class="filter">   
          <input type="checkbox" id="servers" /> <label for="servers">Servers</label>
          <input type="checkbox" id="supernodes" /> <label for="supernodes">Supernodes</label>
          <input type="checkbox" id="gateways" /> <label for="gateways">Gateways</label>
          <input type="checkbox" id="potatos" /> <label for="potatos">Potatos</label>
      </form></td>
      <td><div style="width: 100px;"></div></td>
      <td><form class="filter">   
          <input type="checkbox" id="ping" /> <label for="ping">ping</label>
          <input type="checkbox" id="rssi" /> <label for="rssi">rssi</label>
          <input type="checkbox" id="traffic" /> <label for="traffic">traffic</label>
      </form></td>
  </tr></table>
  <!--hr/-->

  <style>
    div.devices {
      display: table;
      padding: 0.5em;
      text-overflow : ellipsis;
      white-space   : nowrap;
      overflow      : hidden; 
    }
    div.head {
      display: table-row;
      font-weight: bold;
      font-size: 1.1em;
    }
    div.head span {
      display: table-cell;
      padding-bottom: 1.0em;
    }
    div.entry {
      display: table-row;
      vertical-align: middle;
      height : 2.0em;
      line-height : 2.0em;
    }
    div.entry span {
      border: 0px solid blue;
    }
    div.entry span.name {
      display: table-cell;
      color: blue;
      font-weight: bold;
      padding-right: 1.5em;
    }
    div.entry span.lastseen {
      display: table-cell;
      color: black;
      padding-left: 1.5em;
    }
    div.entry span.status {
      display: table-cell;
      color: green;
      padding-right: 1.5em;
    }
    div.entry span.traffic {
      display: table-cell;
      color: gray;
      padding-right: 1.5em;
    }
    div.entry span.graph {
      display: table-cell;
      margin: 0px; padding: 0px;
      border: 1px solid lightgray;
      background: #eee;
      -webkit-border-radius : 0.5em;
      padding-left: 0.25em;
      padding-right: 0.25em;
    }
    div.entry br {
      /*line-height: 0.5em;*/
    }
  </style>

  <div class="devices">
    <!-- div class="head">
      <span>Name</span>
      <span>Status</span>
      <span>Traffic</span>
      <span>Last 24 Hours</span>
    </div -->
    <div class="entry">
      <span class="name">gateway-is-1</span> 
      <span class="status">healthy</span>
      <span class="traffic">123MB</span>
      <span class="graph"><div style="font-size: 0.5em; width:80.0em; height:4.0em;" id="graph_10_0_0_6"></div></span>
    </div><br/>
    <div class="entry">
      <span class="name">10.0.0.3</span> 
      <span class="status">healthy</span>
      <span class="traffic">523MB</span>
      <span class="graph"><div style="font-size: 0.5em; width:80.0em; height:4.0em;" id="graph_10_0_0_3"></div></span>
    </div>
  </div>

</div>

<script type="text/javascript"> //<![CDATA[    
(function() {

  /** includes ------------------------------------------------------------ */
  //load("javascript/jquery/jquery.sparkline.js");
  load("javascript/jquery/jquery.flot.min.js");
  /* often a good idea:  load("modules/network.devices.js"); *;/

  /** construction -------------------------------------------------------- */
  ready = function() { // INJ 'ready' should be the only symbol we're exposing to the global namespace
    /* often a good place to do this: populate_control(); */
    console.debug("loaded network.devices.html");

    
    var channel = afrimesh.network.devices(function(error, devices) {
        if (error) {
          console.log("Error1: " + error);
          return error;
        }
        var channel = afrimesh.network.devices.status(devices, function(error, device) {
            if (error) {
              console.log("Error2: " + error);
              return error;
            }
          });
        console.log("CHANNEL2: " + channel);
      });
    console.log("CHANNEL1: " + channel);

    // poll channel for request completion
    

    // query db for available status queues
    var items = $.ajax({ 
        type    : "GET",
        url     : "http://192.168.20.105/cgi-bin/villagebus/root/db/keys/status/*",
        contentType : "application/json",
        dataType    : "jsonp",
        context: document.body,
        success : function(data) {
          console.log("GREAT SUCCESS: " + data[0]);
        },
        error   : function(data) {
          console.log("Error: ");
          console.log(data);
        }
      });  


    var gateway = [];
    var nexthop = [];
    for (var i = 0; i < 24 * 6; i++) {
      gateway.push([i, Math.random()]);
      nexthop.push([i, Math.random()]);
    }

    //$(".graph").sparkline(data, { });
    //$(".graph").sparkline(data, { height : "2.0em" });

    $.plot($("#graph_10_0_0_6"), [ { label: "gateway", data : gateway }, { label: "nexthop", data : nexthop } ], { 
        series : { lines : { show : true }, points : { show : false } },
        grid   : { show : false } 
      });

    gateway = [];
    nexthop = [];
    for (var i = 0; i < 24 * 6; i++) {
      gateway.push([i, Math.random() - 0.5]);
      nexthop.push([i, Math.random() - 0.5]);
    }
    $.plot($("#graph_10_0_0_3"), [ { label: "gateway", data : gateway }, { label: "nexthop", data : nexthop } ], { 
        series : { lines : { show : true }, points : { show : false } },
        grid   : { show : false } 
      });

    update();
    return unload;
  };

  function unload() {
    clearTimeout(timer);
    console.debug("unloaded network.devices.html");
  };


  /** populate control ---------------------------------------------------- */
  var timer = {};
  function update() {
    /* clearTimeout(timer); */

    /* Setup filter */
    $("div#network-devices .filter").mousedown(function(event) { return false; });
    $("div#network-devices .filter input[type=checkbox]").hide().click(function(event) {
        $(this).toggleClass("active");
        $(this).next("label").toggleClass("active");
        //$(this).next("label").toggleClass("shadow");
        //$(this).attr('checked') ? $(".entry." + this.id).show() : $(".entry." + this.id).hide();
        $(this).is(':checked') ? $(".entry." + this.id).slideDown(100) : $(".entry." + this.id).slideUp(100);
      });
    $("div#network-devices .filter label").addClass("round");
    //$("div#network-devices .filter label").addClass("shadow");
    $("div#network-devices .filter input[type=checkbox]").each(function(e) { return $(this).click(); });


    /* TODO - afrimesh.network.devices.async(populate_devices); */
    //var routers = afrimesh.network.routers();
    //populate_devices(routers);

    /* Add all devices on the network to our list */


    /* timer = setTimeout(update, 5000); */
  };
  function populate_devices(routers) {
    /* get accounting info for routers */
    routers = afrimesh.network.accounting.routers(routers);
    var html = "<table border=1>"
    html += "<thead><th>mac</th><th>address</th><th>packets</th><th>bytes</th><!-- th>version</th><th>uname</th --></thead>";
    html += "<tbody></tbody></table>";
    $("div#network-devices").html(html);
    var table = $("#network-devices table > tbody:last");
    var rows = "";
    routers.map(function(router) {
        var packets = (router.traffic.packets ? router.traffic.packets : "-");
        var bytes   = (router.traffic.bytes   ? pretty_bytes(router.traffic.bytes) : "-");
        rows += "<tr>";
        rows += "<td id='mac'>"     + (router.mac ? router.mac : "-")  + "</td>";
        rows += "<td id='address'>" + router.address + "</td>";
        rows += "<td id='traffic'>" + packets + "</td>";
        rows += "<td id='traffic'>" + bytes   + "</td>";
        //rows += "<td id='version'>" + "" /*afrimesh.villagebus.sys.version(router.address)*/ + "</td>";
        //rows += "<td id='uname'>uname</td>";
        // TODO - this should be cached, async & wrapped around the router like accounting above
        //rows += "<td id='uname'>"   + "" /*afrimesh.villagebus.sys.uname(router.address)*/ + "</td>";
        rows += "</tr>";
      });
    table.append(rows);
  };


  /** done ---------------------------------------------------------------- */
  console.debug("loaded network.devices.js");
 
})();
//]]></script>


