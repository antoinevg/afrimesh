<!--
 * Afrimesh: easy management for B.A.T.M.A.N. wireless mesh networks
 * Copyright (C) 2008-2009 Meraka Institute of the CSIR
 * All rights reserved.
 *  
 * This software is licensed as free software under the terms of the
 * New BSD License. See /LICENSE for more information.
-->

<!-- h2>Settings</h2 -->

<form class="two-column">

  <table border=0>
    <tr valign="top">

      <td>
        <fieldset>
          <legend>Network</legend>
          <div class="label">IP Address</div>
          <input  id="afrimesh|settings|network|wireless|address" />
          <div class="tooltip"><h3>ip address</h3></div>
          <div class="label">Netmask</div>
          <input  id="afrimesh|settings|network|wireless|netmask" />
          <div class="tooltip"><h3>netmask</h3></div>
        </fieldset>
        
        <fieldset>
          <legend>Wireless</legend>
          <div class="label">Channel</div>
          <input  id="afrimesh|settings|network|wireless|channel" />
          <div class="tooltip"><h3>channel</h3></div>
          <div class="label">SSID</div>
          <input  id="afrimesh|settings|network|wireless|ssid" />
          <div class="tooltip"><h3>ssid</h3></div>
          <div class="label">BSSID</div>
          <input  id="afrimesh|settings|network|wireless|bssid" />
          <div class="tooltip"><h3>bssid</h3></div>
        </fieldset>      

        <fieldset>
          <legend>Map</legend>
          <div class="label">Map Server</div>
          <input id="afrimesh|settings|map|server"  type="text" />
          <div class="tooltip"><h3>map server</h3>
            <p class="explain">The Network Map gets the terrain data from the server at this address.</p>
            <p class="typical">If your mesh has internet access you will not need to change this setting.</p>
            <p class="obstacle">
              If your mesh does not have internet access you will need to set up your own map server and enter its address here.
            </p>
            <p class="learnmore">
              You can learn how to set up your own map server by reading 
              <a href="http://code.google.com/p/afrimesh/wiki/HowTo">HowToMapServer</a>
            </p>
          </div>
        </fieldset>      
      </td>

      <td>
        <fieldset>
          <legend>B.A.T.M.A.N.</legend>
          <div class="label">Vis Server</div>
          <input id="afrimesh|settings|network|mesh|vis_server" style="background:#FFAAAA;" />
          <div class="tooltip"><h3>visualization server</h3>
            <p class="explain">The Network Map gets the available mesh nodes and their connections from the server at this address.</p>
            <p class="typical">
              By default the visualization server runs on the same address as the dashboard server and you should not need to change it.
            </p>
            <p class="learnmore">
              You can learn how to configure a different vis server by reading the
              <a href="http://code.google.com/p/afrimesh/wiki/HowTo">HowtoVisServer</a>
            </p>
            <p id="vis_server|error" style="color:#FF0000;"></p>
          </div>
          <div class="label">Gateway</div>
          <input id="is_mesh_gateway" name="is_mesh_gateway" type="checkbox"  />
          <div class="routing_class">
            <div class="label">Routing Class</div>
            <select id="afrimesh|settings|network|mesh|routing_class">
              <option value="0">disable default route</option>
              <option value="1">use fastest connection</option>
              <option value="2">use most stable connection</option>
              <option value="3">auto</option>
            </select>
            <div class="tooltip"><h3>routing class</h3></div>
          </div>
          <div class="gateway_class">
            <div class="label">Gateway Class</div>
            <input  id="afrimesh|settings|network|mesh|gateway_class" />
            <div class="tooltip"><h3>gateway class</h3> 
              <p class="explain">
                The gateway class is used to tell other nodes in the
                network your available internet bandwidth.  Enter any
                number (optionally followed by "kbit" or "mbit") and
                the daemon will guess your appropriate gateway
                class. Use "/" to seperate the download and upload
                rates. You can omit the upload rate and batmand will
                assume an upload of download / 5.
              </p>
              <p class="typical">
                default: <code>0 -> gateway disabled</code>
                examples: <br/>
                <code>5000<br/>
                  5000kbit<br/>
                  5mbit<br/>
                  5mbit/1024<br/>
                  5mbit/1024kbit<br/>
                  5mbit/1mbit<br/>
                </code>
              </p>
            </div>
          </div>
        </fieldset>
        
        <fieldset>
          <legend>Telephony</legend>
          <div class="label">Extension</div>
          <input  id="extension" />
          <div class="tooltip"><h3>user extension</h3></div>
          <div class="label">Inbound DID</div>
          <input  id="did|inbound" />
          <div class="tooltip"><h3>inbound did</h3></div>
          <div class="label">Trunk Calls</div>
          <input id="afrimesh|settings|potato|trunkcalls" type="checkbox"  />
          <div class="trunk">
            <div class="label">Asterisk Server</div>
            <input  id="afrimesh|settings|potato|asterisk" />
            <div class="tooltip"><h3>asterisk</h3></div>
          </div>
        </fieldset>
      </td>
  </tr></table>

  <fieldset>
    <div class="label">Location</div>
    <input id="location" />
  </fieldset>

</form>


<script type="text/javascript"> //<![CDATA[    
(function() {

  /** includes ------------------------------------------------------------ */
  load("modules/utility.settings.js"); 


  /** construction -------------------------------------------------------- */
  ready = function() { // INJ 'ready' should be the only symbol we're exposing to the global namespace
    console.debug("loaded utility.settings.html");

    /** set controls to the values of afrimesh.settings.* ----------------- */
    populate_dom();

    /** install tooltips -------------------------------------------------- */
    $("input.[id*=afrimesh]").tooltip({
        position : ['bottom', 'right'],   // place tooltip on the right edge 
        offset   : [-20, 20],             // a little tweaking of the position 
        effect   : 'toggle',              // use a simple show/hide effect 
        opacity  : 0.8                    // custom opacity setting 
      });

    /** round corners ------------------------------------------------------ */
    $(".tooltip").corner("tr 8px bl 8px br 8px");

    /** style controls ----------------------------------------------------- */
    $('form.two-column :checkbox').slider();

    /** install callbacks to save settings -------------------------------- */
    function save_element(id, value) {
      return (Q(afrimesh, id) != value) ? afrimesh.settings.save(id, value) : null;
    };
    $("input.[id*=afrimesh|settings]").bind("blur", function(event) {
        console.debug("Saving Setting: " + this.id + " -> " + this.value);
        save_element(this.id, this.value);
        populate_dom();
      });
    $("input.[id*=afrimesh|settings]").bind("keypress", function(event) {
	      if (event.keyCode == 13) {
	        console.debug("Saving Setting: " + this.id + " -> " + this.value);
          save_element(this.id, this.value);
          populate_dom();
 	      } 
      });
    $("select.[id*=afrimesh|settings]").bind("blur", function(event) { 
        save_element(this.id, this.value); 
    });
    $("input.[id*=afrimesh|settings|network|mesh|vis_server]").bind("blur", function(event) { 
        console.debug("Override Setting for vis server " + this.id + " -> " + this.value);
        save_element(this.id, this.value);
        update_vis_server();
      });
    $("#is_mesh_gateway").bind("change", function(event) { 
        if ($("input[name='is_mesh_gateway']").attr("checked")) {
          $(".routing_class").hide();
          $(".gateway_class").show();
          $("select.[id*=afrimesh|settings|network|mesh|routing_class]").val(0);
          save_element("afrimesh|settings|network|mesh|routing_class", "");
        } else {
          $(".routing_class").show();
          $(".gateway_class").hide();
          $("input.[id*=afrimesh|settings|network|mesh|gateway_class]").val("");
          save_element("afrimesh|settings|network|mesh|gateway_class", "");
        }
      });
    $("input.[id=afrimesh|settings|potato|trunkcalls]").bind("change", function(event) { 
        save_element(this.id, this.checked.toString());
        update_asterisk_server();
      });
    $("input.[id=afrimesh|settings|potato|asterisk]").bind("blur", function(event) { 
        save_element(this.id, this.value);
        update_asterisk_server();
      });

    /** update mesh routing controls --------------------------------- */
    update_mesh_controls();

    /** query asterisk server for availability ----------------------- */
    update_asterisk_server();

    /** query vis server for availability --------------------- */
    update_vis_server();

    /** create map to set dashboard location ------------------------------ */
    $("#location").replaceWith("<div id='location' />");
    var location_map = new LocationMap("location", 
                                       parseFloat(afrimesh.settings.location.longitude),
                                       parseFloat(afrimesh.settings.location.latitude),
                                       parseFloat(afrimesh.settings.map.extent),
                                       parseInt(afrimesh.settings.map.zoom));
    var router = { address : afrimesh.settings.address };
    location_map.router(router);
  
    return unload;
  };

  function unload() {
    console.debug("unloaded utility.settings.html");
  };

  /** done ---------------------------------------------------------------- */
  console.debug("loaded utility.settings.js");
 
})();
//]]></script>


