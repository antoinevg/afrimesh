<!--
 * Afrimesh: easy management for B.A.T.M.A.N. wireless mesh networks
 * Copyright (C) 2008-2009 Meraka Institute of the CSIR
 * All rights reserved.
 *  
 * This software is licensed as free software under the terms of the
 * New BSD License. See /LICENSE for more information.
-->


<div class="utility-upgrade">

  <table border=0 width=600>
    <thead id="network-updates"><th colspan=2>Update Potato</th></thead>
    <tr id="packages" valign="top" style="height: 3.0em;">
      <td width=550>Check for updated packages</td><td width=50><button>check</button></td>
    </tr>
    <tr id="firmware" valign="top" style="height: 3.0em;">
      <td width=550>Check for updated firmware</td><td width=50><button>check</button></td>
    </tr>
    
    <tr><td colspan=2>&nbsp;</td></tr>
    
    <thead id="reflash-firmware"><th colspan=2>Reflash Potato</th></thead>
    <tr id="upload" valign="top" style="height: 3.0em;">
      <td width=550>Upload new firmware</td><td width=50><button>browse</button></td>
    </tr>
  </table>

</div>

<script type="text/javascript"> //<![CDATA[    
(function() {

  /** includes ------------------------------------------------------------ */
  /* load includes with: load("path/to/file.js");   */
  /* often a good idea:  load("modules/utility.upgrade.js"); *;/

  /** construction -------------------------------------------------------- */
  ready = function() { // INJ 'ready' should be the only symbol we're exposing to the global namespace
    console.debug("loaded utility.upgrade.html");
    $("#packages button").click(onpackages);
    $("#firmware button").click(onfirmware);
    $("#upload button").click(onupload);
    return unload;
  };

  function unload() {
    console.debug("unloaded utility.upgrade.html");
  };


  /** update packages ------------------------------------------------------ */

  function onpackages() {
    $("#network-updates th").html("Update Potato Packages");
    $("#packages button").unbind("click");
    $("#packages button").html("<img src='images/indicator.gif'/>");
    $("#packages td:eq(0)").html("<pre>Updating package list...</pre>");
    $("#firmware").html("");
    $("#upload").html("");
    $("#reflash-firmware").html("");

    var address = "192.168.20.2";
    //var address = "10.0.0.42";

    afrimesh.villagebus.ipkg.update.async(update_complete, address);
    function update_complete(log) {
      $("#packages td:eq(0)").append("<pre>" + log.join("\n") + "</pre>");
      afrimesh.villagebus.ipkg.list.async(list_complete, address, "upgradable");
    };

    function list_complete(packages) {
      var updates = $("#packages td:eq(0)").html("");
      var html = "<table cellspacing=0 cellpadding=0 border=0 style='margin:0px; padding:0px;'>";
      packages.map(function(package) { 
          html += "<tr>" + "<td><pre>" + package.name    + "</pre></td>" + 
                           "<td><pre>" + package.version + "</pre></td>" +
                           "<td><pre>" + package.comment + "</pre></td></tr>";
        });
      html += "</table";
      updates.append(html);
      $("#packages button").html("update");  
      $("#packages button").click(function() { 
          $("#packages button").unbind("click");
          $("#packages button").html("<img src='images/indicator.gif'/>")
          $("#packages td:eq(0)").html("<pre>Updating packages...</pre>");
          upgrade_complete([], packages);
        });  
    };
    
    function upgrade_complete(log, packages) {
      $("#packages td:eq(0)").append("<pre>" + log.join("\n") + "</pre>");
      if (packages.length) {
        var package = packages.pop();
        afrimesh.villagebus.ipkg.upgrade.async(function(log) { 
            upgrade_complete(log, packages); 
          }, address, package.name);
        return;
      }
      $("#packages button").html("done")
    };
  };


  /** update firmware ------------------------------------------------------ */

  function onfirmware() {
    console.debug("updating firmware");
    $("#firmware td:eq(0)").html("Checking...");
    $("#firmware button").html("<img src='images/indicator.gif'/>");
  };


  /** upload firmware ------------------------------------------------------ */

  function onupload() {
    console.debug("uploading firmware");
    afrimesh.villagebus.ipkg.upgrade.async(function(log) {
        console.debug(log);
      }, "192.168.20.2", "afrimesh-base");
  };


  /** done ---------------------------------------------------------------- */
  console.debug("loaded utility.upgrade.js");
 
})();
//]]></script>

