#summary TODO - replace with afrimesh-config package
#labels Phase-Deploy
#KB-TODO do this in real detail for newbies (when we've got something rock solid)

Afrimesh requires an out-of-the-box Openwrt install plush the afrimesh-base package and its dependencies (libuci, libjson, batmand, libnetsnmp).  The overall proceess is:
* Install openwrt
* update opkg source file
* edit afrimesh config script with your values
* run afrimesh config script

= Flash router with Openwrt = 

Afrimesh currently uses Kamikaze - 8.09.2

* Get the correct openwrt image for your platform from here http://downloads.openwrt.org/kamikaze/8.09.2/
* Flash your router...

= Download Config Files and Scripts =

* telnet to your router (192.168.1.1)
{{{
cd /etc
rm opkg.conf
wget http://afrimesh.googlecode.com/files/opkg.conf
wget http://afrimesh.googlecode.com/files/amcfg-node.sh
wget http://afrimesh.googlecode.com/files/amcfg-gw.sh
}}}

= Customize Your Configuration =



= Configuration Parameters =
|| *parameter* || *description* || *example* || *actual* . . . . . . . . . . . . . . . . . . . . ||
|| ifname || Your wireless interface || wl0 on broadcom & ath0 on atheros ||  ||
|| channel || The channel your mesh is running on || e.g. 5 ||  ||
|| ssid || The SSID your mesh is using || e.g. batman ||  ||
|| bssid || The BSSID your mesh is using || e.g. "BB:BB:BB:BB:BB:BB" ||  ||
|| ipaddr || The ip address your router will have on the mesh || e.g. 10.0.0.6 || ||
|| netmask || The netmask your mesh uses || e.g. 255.0.0.0 || ||
|| visualisation_srv || The ip address of the B.A.T.M.A.N. vis server || e.g. 192.168.20.225 || ||
|| dns || The ip address of your dns server || e.g. 192.168.20.5 || ||


= Flashing The Router =

  * FlashMerakiMini
  * FlashLinksysWRT54GL


= Basic Router Configuration =
  # Plug computer into router ethernet
  # Set computer IP to 192.168.1.9
  # Telnet into router
  {{{
  telnet 192.168.1.1
  }}}
  # Run:
  {{{
  uci delete network.lan.type
  uci set network.lan.dns=<dns>
  uci set network.wifi=interface
  uci set network.wifi.ifname=<ifname>
  uci set network.wifi.proto=static
  uci set network.wifi.ipaddr=<ipaddr>
  uci set network.wifi.netmask=<netmask>
  uci set wireless.wifi0.disabled=0
  uci set wireless.wifi0.channel=<channel>
  uci set wireless.@wifi-iface[0].ssid=<ssid>
  uci set wireless.@wifi-iface[0].mode=adhoc 
  uci set wireless.@wifi-iface[0].bssid=<bssid>
  uci set wireless.@wifi-iface[0].network=wifi        
  uci set batmand.general.routing_class=3
  uci set batmand.general.visualisation_srv=192.168.20.225
  uci add firewall include
  uci set firewall.@include[-1].path="/etc/firewall.afrimesh"   
  uci commit
  /etc/init.d/batmand enable
  reboot
  }}}  


= afrimesh-portal (Optional) = 
afrimesh-portal provides the configuration files to run a [http://coova.org CoovaChilli] captive portal on each mesh router.

The captive portal software is used to control access to the mesh&internet as well as enforcing bandwidth allocation.

  # Run:
  {{{
  opkg update
  opkg install afrimesh-portal
  uci set network.lan.ipaddr=0.0.0.0
  uci commit
  # Broken ??? /etc/init.d/chilli enable
  cd /etc/rc.d ; ln -s ../init.d/chilli S70chilli 
  reboot
  }}}